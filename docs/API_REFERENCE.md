# SomaAgentHub API Reference (Current)

Updated: 2025-10-08

This is the authoritative, current API guide for SomaAgentHub services. It documents real, implemented endpoints only, with request/response shapes, example calls, error models, and guidance on when/why to use each API—especially for agent workflows.

Services covered:
- Gateway API (public entrypoint)
- Orchestrator API (Temporal-backed workflows)
- Analytics Service
- Policy Engine
- Notification Service
- Tool Service
- Task Capsule Repository
- Billing Service
- Common system endpoints (/health, /metrics)

Notes:
- All services expose `GET /health` and `GET /metrics` for observability.
- Multi-tenant context is propagated via request context; see Gateway “Context” section.
- Authentication/authorization is not enforced in this snapshot; add it before production.

---

## 1) Gateway API

Base URL: http://gateway-api.svc.cluster.local:8080 (K8s) or http://localhost:60000 (local uvicorn)

OpenAPI: auto-generated by FastAPI (if you run the app)

### Purpose
- Public entrypoint for UI/CLI/agents
- Moderates inputs and forwards to Orchestrator
- Provides wizard-based project onboarding
- Router helpers for multi-region scenarios

### Key Endpoints

- GET `/health` (system)
  - Returns health metadata.
  - Response: `{ "status": "ok", "service": "gateway-api" }`

- GET `/metrics` (system)
  - Prometheus metrics; scrape via ServiceMonitor.

- GET `/` (root)
  - Informational banner.

- GET `/v1/status` (gateway)
  - Context echo for debugging (tenant, client type, etc.).
  - Response example:
    ```json
    {
      "service": "gateway",
      "state": "ready",
      "tenant": "acme",
      "client_type": "agent",
      "deployment_mode": "k8s"
    }
    ```

- POST `/v1/sessions` (gateway)
  - Description: Moderate input, then forward to Orchestrator session start.
  - Request model (SessionCreateRequest, simplified):
    ```json
    {
      "prompt": "Plan a product launch for Q4",
      "capsule_id": "marketing.campaign.v1",
      "metadata": { "priority": "high" }
    }
    ```
  - Response (SessionCreateResponse, simplified):
    ```json
    {
      "session_id": "sess-123",
      "status": "accepted",
      "moderation": {
        "passed": true,
        "reason": "safe"
      },
      "payload": { /* orchestrator session payload/echo */ }
    }
    ```
  - When to use: Agents or clients initiating a new orchestration session via a moderated, public API.

- Wizard endpoints (wizard)
  - GET `/v1/wizards` → List available wizards
  - POST `/v1/wizards/start` → Start a wizard session
    - Body: `{ "wizard_id": "project_planner", "user_id": "demo-user", "metadata": { ... } }`
  - GET `/v1/wizards/{session_id}` → Fetch wizard session state
  - POST `/v1/wizards/{session_id}/answer` → Submit a step answer
  - POST `/v1/wizards/{session_id}/approve` → Approve and execute the plan
  - When to use: Interactive, stepwise onboarding for projects/plans before orchestration.

- Dashboard endpoints (dashboard)
  - GET `/v1/dashboard/health` → Aggregated system health (SLM provider, memory gateway, Kafka, Redis, etc.).
  - When to use: Quick operational overview for agents or dashboards.

### Context & Moderation
- Request context injected by dependencies (tenant_id, user_id, client_type, deployment_mode).
- ModerationGuard runs before forwarding to orchestrator; emits metrics and returns moderation results in response.

### Example: Agent creates a session via Gateway
```bash
curl -s -X POST http://localhost:60000/v1/sessions \
  -H 'Content-Type: application/json' \
  -d '{
    "prompt": "Plan a Q4 product launch with social + email",
    "capsule_id": "marketing.campaign.v1",
    "metadata": {"priority": "high"}
  }'
```

---

## 2) Orchestrator API

Base URL: http://orchestrator.svc.cluster.local:8000 (K8s) or http://localhost:60002 (local uvicorn)

### Purpose
- Temporal-backed workflow coordination for sessions, projects, and multi-agent orchestration (MAO).

### Key Endpoints

- GET `/health`, GET `/metrics`, GET `/` (system)

- Router: `/v1/*` (tag: orchestrator)
  - Imported sub-routers: conversation, projects, training.

- POST `/v1/sessions/start`
  - Starts a new session workflow (SessionStart).
  - Request (SessionStartRequest, inferred):
    ```json
    {
      "prompt": "Plan a Q4 product launch with social + email",
      "capsule_id": "marketing.campaign.v1",
      "tenant_id": "acme",
      "user_id": "agent-001",
      "metadata": {"priority": "high"}
    }
    ```
  - Response (SessionStartResponse, inferred):
    ```json
    {
      "session_id": "sess-123",
      "workflow_id": "session-sess-123",
      "run_id": "a1b2c3",
      "status": "started"
    }
    ```
  - When to use: Internal or privileged callers (Gateway) to initiate orchestration.

- POST `/v1/mao/start`
  - Starts a multi-agent orchestration workflow (MAO).
  - Request (MultiAgentStartRequest): includes one or more AgentDirective and problem statement.
  - Response (MultiAgentStartResponse): workflow_id, run_id, orchestration_id, task_queue.
  - When to use: Launch a coordinated set of agents on a task.

- Projects (planner/wizard lifecycle)
  - POST `/v1/projects/analyze` → Generate plan outline from brief.
  - POST `/v1/projects/{plan_id}/intake` → Advance intake flow (collect details/artifacts).
  - POST `/v1/projects/{plan_id}/approve` → Approve plan; begin execution.
  - When to use: Structured project planning and execution lifecycle.

### Example: Direct start of a session (bypassing Gateway)
```bash
curl -s -X POST http://localhost:60002/v1/sessions/start \
  -H 'Content-Type: application/json' \
  -d '{
    "prompt": "Plan a Q4 product launch",
    "capsule_id": "marketing.campaign.v1",
    "tenant_id": "acme",
    "user_id": "agent-001",
    "metadata": {"priority": "high"}
  }'
```

---

## 3) Analytics Service

Base URL: http://analytics-service:8005

### Purpose
- Ingest and summarize operational/billing/QA events; expose dashboards and rollups.

### Endpoints (subset)
- GET `/kamachiq/summary` → Summary of KAMACHIQ runs.
- POST `/kamachiq/blocked` / `/kamachiq/resolved` → Track blocked/resolved items.
- POST `/billing/events` → Ingest token/cost events.
- GET `/billing/ledgers` → Aggregate billing totals per tenant/capsule/service.
- Various drill endpoints (e.g., `/drills/disaster`).

### When to use
- Agents/services sending analytics and billing telemetry; operators querying rollups.

---

## 4) Policy Engine

Base URL: http://policy-engine:8001

### Purpose
- Evaluate content/requests against policy rules; produce allow/deny and severity/score.

### Endpoints
- POST `/v1/evaluate` → `EvaluationResponse` (allow, violations[])
- POST `/v1/score` → `ScoreResponse` (numeric scoring)
- GET `/v1/policies/{tenant}` → list of `PolicyRule`
- PUT `/v1/policies/{tenant}` → update rules

### When to use
- Pre-flight checks before orchestration; agent self-guardrails; compliance.

### Example
```bash
curl -s -X POST http://policy-engine:8001/v1/evaluate \
  -H 'Content-Type: application/json' \
  -d '{"text": "Sample content to check", "tenant": "acme"}'
```

---

## 5) Notification Service

Base URL: http://notification-service:8004

### Purpose
- Orchestrate cross-channel notifications (Slack/email/etc.)

### Endpoints
- POST `/v1/notifications` → enqueue notification (202)
- GET `/v1/notifications/backlog` → pending queue (bounded by `cache_limit`)

### When to use
- Agents/services emitting notifications on workflow milestones or incidents.

---

## 6) Tool Service

Base URL: http://tool-service:8006

### Purpose
- Hosts adapters for external tools (Plane, GitHub, Notion), records audit events.

### Endpoints
- Mounted under `/v1/...` via `app.include_router(router)`; see service for specific adapters.

### When to use
- Agents needing CRUD/integration against external systems through a uniform API.

---

## 7) Task Capsule Repository

Base URL: http://task-capsule-repo:8007

### Purpose
- Manage versioned task definitions (capsules); installations; reviews.

### Endpoints (subset)
- GET `/v1/capsules` / POST `/v1/capsules` / GET `/v1/capsules/{capsule_id}`
- See `services/task-capsule-repo/app/api/routes.py` for full CRUD, installs, reviews.

### When to use
- Agents discovering/installing task capsules to enable capabilities.

---

## 8) Billing Service

Base URL: http://billing-service:8008

### Purpose
- Subscription and usage endpoints (scaffolded); Prometheus metrics/health.

### Endpoints (scaffold)
- GET `/subscriptions` / POST `/subscriptions`
- GET `/usage`

---

## 9) Common System & Observability

All services expose:
- GET `/health`
- GET `/metrics` (Prometheus)

Kubernetes scraping is configured via `k8s/monitoring/servicemonitors.yaml`. Services should:
- expose `/metrics` on a port named `metrics`
- add label `monitoring: enabled` on the Service

---

## End-to-End: Agent → Gateway → Orchestrator

Recommended path for agents:
1) POST Gateway `/v1/sessions` with `{ prompt, capsule_id, metadata }`.
2) Gateway moderates, forwards to Orchestrator `/v1/sessions/start` with tenant/user context.
3) Orchestrator starts Temporal workflows; returns IDs.
4) Use Notification/Analytics/Policy as needed during/after execution.

Minimal curl (local dev):
```bash
# Start orchestrator session via Gateway
curl -s -X POST http://localhost:60000/v1/sessions \
  -H 'Content-Type: application/json' \
  -d '{
    "prompt": "Plan a Q4 product launch with social + email",
    "capsule_id": "marketing.campaign.v1",
    "metadata": {"priority": "high"}
  }'
```

---

## Error Model

- HTTP 4xx/5xx with `{"detail": "..."}` from FastAPI’s HTTPException on errors.
- Gateway returns 502 if orchestrator is unavailable.
- Orchestrator returns 4xx on validation, 5xx on workflow issues; includes `workflow_id` where applicable.

---

## Rate Limits & Idempotency

- Not enforced in this snapshot; add Gateway-side rate limiting and idempotency keys for production.

---

## Security & Auth (Next)

- Add JWT/OIDC headers to Gateway; forward verified claims to Orchestrator context.
- Use service accounts and NetworkPolicies inside the cluster.

---

## Appendix: Service Discovery

- Gateway local: `uvicorn services/gateway-api/app.main:app --reload --port 60000`
- Orchestrator local: `uvicorn services/orchestrator/app.main:app --reload --port 60002`
- Prometheus UI (port-forward): http://localhost:9090
- Loki (optional port-forward): http://localhost:3100
